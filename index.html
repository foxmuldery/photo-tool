function updatePreview(isPreview = true) {
    if (images.length === 0) return;

    const img = images[currentImageIndex];
    const borderWidth = parseInt(document.getElementById('borderWidth').value) / 100;
    const strokeWidth = 2;
    const description = photoDescription.value.trim();
    const fontSize = parseInt(fontSizeSelect.value);
    const lineHeight = fontSize * 1.5;
    const lines = description.split('\n');
    const textHeight = lines.length * lineHeight;

    let imageWidth, imageHeight;
    if (isPreview) {
        // 预览时使用较小尺寸
        const maxPreviewSize = Math.min(window.innerWidth * 0.8, 800);
        const scale = maxPreviewSize / Math.max(img.naturalWidth, img.naturalHeight);
        imageWidth = img.naturalWidth * scale;
        imageHeight = img.naturalHeight * scale;
    } else {
        // 导出时使用原始尺寸，但应用一定的缩放以减小文件大小
        const maxOutputSize = 2000; // 限制最大输出尺寸
        if (img.naturalWidth > maxOutputSize || img.naturalHeight > maxOutputSize) {
            const scale = maxOutputSize / Math.max(img.naturalWidth, img.naturalHeight);
            imageWidth = img.naturalWidth * scale;
            imageHeight = img.naturalHeight * scale;
        } else {
            imageWidth = img.naturalWidth;
            imageHeight = img.naturalHeight;
        }
    }

    const borderSize = imageWidth * borderWidth;
    const canvasWidth = imageWidth + (borderSize * 2);
    const canvasHeight = imageHeight + (borderSize * 2) + (description ? textHeight + borderSize : 0);

    canvas.width = canvasWidth;
    canvas.height = canvasHeight;

    // 高质量设置
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    // 绘制白色背景
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);

    // 绘制图片
    ctx.drawImage(img, borderSize, borderSize, imageWidth, imageHeight);

    // 绘制边框
    ctx.strokeStyle = '#999999';
    ctx.lineWidth = strokeWidth;
    ctx.strokeRect(
        borderSize - strokeWidth/2,
        borderSize - strokeWidth/2,
        imageWidth + strokeWidth,
        imageHeight + strokeWidth
    );

    if (description) {
        ctx.fillStyle = 'black';
        const fontFamily = fontFamilySelect.value;
        ctx.font = `${fontSize}px "${fontFamily}"`;
        
        const textPadding = borderSize * 0.2;
        const maxTextWidth = canvasWidth - (borderSize * 2 + textPadding * 2);
        const textY = imageHeight + borderSize * 2 + fontSize; // 调整文字垂直位置
        
        drawText(ctx, description, borderSize + textPadding, textY, maxTextWidth);
    }

    // 适应预览区域
    const previewArea = document.getElementById('previewArea');
    const previewWidth = previewArea.offsetWidth - 32; // 减去padding
    const previewHeight = previewArea.offsetHeight - 32;
    const canvasRatio = canvasWidth / canvasHeight;
    const containerRatio = previewWidth / previewHeight;

    if (canvasRatio > containerRatio) {
        canvas.style.width = previewWidth + 'px';
        canvas.style.height = (previewWidth / canvasRatio) + 'px';
    } else {
        canvas.style.height = previewHeight + 'px';
        canvas.style.width = (previewHeight * canvasRatio) + 'px';
    }
}
